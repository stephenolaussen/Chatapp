<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Familieskatt - Chat rom">
    <meta name="theme-color" content="#667eea">
    <title>Familie chat - <%- room %></title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      html {
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        color: #333;
        overflow: hidden;
      }

      .header {
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(10px);
        padding: 1rem 1.5rem;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        position: sticky;
        top: 0;
        z-index: 50;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .online-users {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
      }

      .online-count {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        padding: 0.35rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: 0 4px 15px rgba(67, 233, 123, 0.4);
      }

      .user-list {
        display: none;
        position: absolute;
        top: 60px;
        right: 10px;
        background: rgba(255, 255, 255, 0.97);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        max-height: 350px;
        overflow-y: auto;
        z-index: 100;
        min-width: 220px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .user-list.show {
        display: block;
      }

      .user-list-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .user-list-item:last-child {
        border-bottom: none;
      }

      .user-badge {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #43e97b;
      }

      .user-list-item-name {
        font-weight: 500;
        color: #333;
      }

      .header h1 {
        font-size: 1.5rem;
        color: #333;
        flex-grow: 1;
        text-align: center;
        font-weight: 600;
        letter-spacing: -0.5px;
      }

      .header a {
        color: #667eea;
        text-decoration: none;
        font-size: 1.2rem;
        transition: all 0.2s;
        padding: 0.5rem;
        border-radius: 8px;
      }

      .header a:hover {
        color: #764ba2;
        background: rgba(102, 126, 234, 0.1);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: linear-gradient(135deg, var(--user-color, #667eea) 0%, var(--user-color-dark, #764ba2) 100%);
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        font-weight: 500;
      }

      .user-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      #messages {
        list-style-type: none;
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      #messages > li {
        display: flex;
        flex-direction: column;
        max-width: 80%;
        word-wrap: break-word;
        position: relative;
      }

      #messages > li.own-message {
        align-self: flex-end;
        max-width: 80%;
      }

      .message-actions {
        display: none;
        position: absolute;
        top: 0.5rem;
        right: -2.5rem;
        gap: 0.5rem;
        z-index: 10;
      }

      #messages > li.own-message .message-actions {
        display: flex;
      }

      .message-actions button {
        background: rgba(102, 126, 234, 0.8);
        border: none;
        color: white;
        width: 1.8rem;
        height: 1.8rem;
        border-radius: 50%;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .message-actions button:hover {
        background: rgba(102, 126, 234, 1);
        transform: scale(1.1);
      }

      .message-bubble {
        padding: 0.85rem 1.2rem;
        border-radius: 18px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #messages > li.own-message .message-bubble {
        background: var(--user-color, #667eea);
        color: white;
        border-bottom-right-radius: 3px;
      }

      #messages > li:not(.own-message) .message-bubble {
        background: var(--message-color, #667eea);
        color: white;
        border-bottom-left-radius: 3px;
      }

      .message-sender {
        font-weight: bold;
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      #messages > li:not(.own-message) .message-sender {
        color: #555;
      }

      #messages > li.own-message .message-sender {
        color: rgba(255, 255, 255, 0.8);
        justify-content: flex-end;
      }

      .message-time {
        font-size: 0.75rem;
        opacity: 0.6;
      }

      #form {
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(10px);
        padding: 1.2rem;
        display: flex;
        gap: 0.75rem;
        box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.08);
        border-top: 1px solid rgba(255, 255, 255, 0.2);
      }

      #input {
        border: 2px solid #e5e7eb;
        padding: 0.85rem 1.2rem;
        flex-grow: 1;
        border-radius: 28px;
        font-size: 1rem;
        transition: all 0.2s;
        background: #f9fafb;
      }

      #input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      #form > button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.85rem 1.8rem;
        border-radius: 28px;
        color: white;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        font-size: 1rem;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      #form > button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      #form > button:active {
        transform: translateY(0);
      }

      .emoji-btn {
        background: white;
        border: 2px solid #e5e7eb;
        padding: 0.6rem 1rem;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1.3rem;
        transition: all 0.2s;
      }

      .emoji-btn:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
        transform: scale(1.05);
      }

      .emoji-btn:active {
        transform: scale(0.95);
      }

      .alarm-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 25px;
        color: white;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        font-size: 1rem;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .alarm-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .alarm-btn:active {
        transform: scale(0.95);
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background-color: white;
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 420px;
        width: 90%;
        animation: slideIn 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes alarm-flash {
        0%, 100% {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        50% {
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }
      }

      .modal h2 {
        margin-bottom: 2rem;
        color: #333;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: #555;
      }

      .form-group input[type="text"],
      .form-group input[type="color"] {
        width: 100%;
        padding: 0.85rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.2s;
        background: #f9fafb;
      }

      .form-group input[type="text"]:focus,
      .form-group input[type="color"]:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .color-options {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .color-option {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .color-option:hover {
        transform: scale(1.12);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .color-option.selected {
        border-color: #333;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #333, 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .modal-buttons {
        display: flex;
        gap: 1rem;
      }

      .modal-buttons button {
        flex: 1;
        padding: 0.9rem;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #e0e0e0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #d0d0d0;
      }

      /* Emoji picker */
      .emoji-picker {
        position: fixed;
        bottom: 80px;
        right: 10px;
        background: rgba(255, 255, 255, 0.97);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        padding: 1.2rem;
        display: none;
        grid-template-columns: repeat(6, 1fr);
        gap: 0.6rem;
        max-width: 320px;
        z-index: 500;
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow: hidden;
      }

      .emoji-picker.show {
        display: grid;
      }

      .emoji-picker span {
        font-size: 1.6rem;
        cursor: pointer;
        padding: 0.65rem;
        border-radius: 8px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .emoji-picker span:hover {
        background: rgba(102, 126, 234, 0.1);
        transform: scale(1.15);
      }

      /* System messages */
      .system-message {
        padding: 0.5rem 1rem;
        text-align: center;
        color: #999;
        font-size: 0.9rem;
        align-self: center;
      }

      /* Edit message modal */
      .edit-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
      }

      .edit-modal.show {
        display: flex;
      }

      .edit-modal-content {
        background-color: white;
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 420px;
        width: 90%;
        animation: slideIn 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .edit-modal h2 {
        margin-bottom: 1.5rem;
        color: #333;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .edit-textarea {
        width: 100%;
        padding: 0.85rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        min-height: 100px;
        margin-bottom: 1.5rem;
        transition: all 0.2s;
      }

      .edit-textarea:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      @media (max-width: 600px) {
        * {
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          user-select: none;
        }

        input, textarea, button {
          -webkit-user-select: text;
          user-select: text;
          -webkit-touch-callout: default;
        }

        body {
          overflow: hidden;
          height: 100dvh;
          width: 100%;
          position: relative;
        }

        #messages > li,
        #messages > li.own-message {
          max-width: 95%;
        }

        .header {
          flex-direction: column;
          gap: 0.5rem;
          padding: 0.75rem 0.75rem;
        }

        .header h1 {
          font-size: 1.2rem;
        }

        .header-left {
          width: 100%;
          justify-content: space-between;
        }

        .online-users {
          position: absolute;
          right: 1rem;
          top: 3.5rem;
        }

        .user-info {
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
        }

        #form {
          padding: 0.75rem;
          gap: 0.5rem;
          flex-wrap: nowrap;
          flex-shrink: 0;
          position: relative;
          z-index: 10;
        }

        #form > button,
        .emoji-btn {
          flex-shrink: 0;
          white-space: nowrap;
          pointer-events: auto;
        }

        #input {
          min-width: 0;
          padding: 0.7rem 1rem;
          font-size: 16px;
          pointer-events: auto;
          -webkit-appearance: none;
          appearance: none;
          border-radius: 8px;
        }

        .emoji-btn {
          padding: 0.5rem 0.75rem;
          font-size: 1.2rem;
        }

        #form > button {
          padding: 0.7rem 1.2rem;
          font-size: 0.9rem;
        }

        #messages {
          padding: 1rem 0.75rem;
        }

        .emoji-picker {
          position: fixed;
          bottom: 65px;
          right: 0;
          left: 0;
          max-width: none;
          width: 100%;
          max-height: 200px;
          grid-template-columns: repeat(5, 1fr);
          border-radius: 20px 20px 0 0;
          padding: 1rem;
          overflow-y: auto;
        }

        .user-list {
          top: 50px;
          right: 5px;
          left: 5px;
          max-width: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-left">
        <a href="/" title="Back to home"><i class="fas fa-arrow-left"></i></a>
        <h1>ğŸ’¬ Familie chat - <%- room %></h1>
      </div>
      <div class="online-users">
        <span class="online-count" id="userCount">1</span>
        <button onclick="toggleUserList()" style="background: none; border: none; cursor: pointer; color: #667eea; font-size: 1.2rem; padding: 0;">
          <i class="fas fa-users"></i>
        </button>
      </div>
      <div class="user-list" id="userList"></div>
      <div class="user-info" id="userInfo" onclick="showUserModal()">
        <span id="userName">User</span>
        <i class="fas fa-edit"></i>
      </div>
    </div>

    <!-- User setup modal -->
    <div id="userModal" class="modal">
      <div class="modal-content">
        <h2>ğŸ‰ Choose Your Name and Color</h2>
        
        <div class="form-group">
          <label for="nameInput">Your name:</label>
          <input type="text" id="nameInput" placeholder="Enter your name..." maxlength="20">
        </div>

        <div class="form-group">
          <label>Choose a color:</label>
          <div class="color-options">
            <div class="color-option" style="background: #667eea;" data-color="#667eea"></div>
            <div class="color-option" style="background: #f093fb;" data-color="#f093fb"></div>
            <div class="color-option" style="background: #4facfe;" data-color="#4facfe"></div>
            <div class="color-option" style="background: #43e97b;" data-color="#43e97b"></div>
            <div class="color-option" style="background: #fa709a;" data-color="#fa709a"></div>
            <div class="color-option" style="background: #fee140;" data-color="#fee140"></div>
            <div class="color-option" style="background: #30b0fe;" data-color="#30b0fe"></div>
            <div class="color-option" style="background: #ec77de;" data-color="#ec77de"></div>
          </div>
          <input type="color" id="colorInput">
        </div>

        <div class="modal-buttons">
          <button class="btn-primary" onclick="saveUserInfo()">Save</button>
        </div>
      </div>
    </div>

    <!-- Password modal -->
    <div id="passwordModal" class="modal">
      <div class="modal-content">
        <h2>ğŸ”’ Enter Password</h2>
        <p style="color: #666; margin-bottom: 1.5rem; text-align: center;">This room requires a password</p>
        
        <div class="form-group">
          <label for="passwordInput">Password:</label>
          <input type="password" id="passwordInput" placeholder="Enter password..." autocomplete="off">
        </div>

        <div class="modal-buttons">
          <button class="btn-primary" onclick="verifyPassword()">Enter</button>
          <button class="btn-secondary" onclick="goBack()">Back</button>
        </div>
      </div>
    </div>

    <ul id="messages"></ul>

    <!-- Edit message modal -->
    <div id="editModal" class="edit-modal">
      <div class="edit-modal-content">
        <h2>âœï¸ Edit Message</h2>
        <textarea id="editTextarea" class="edit-textarea" placeholder="Edit your message..."></textarea>
        <div class="modal-buttons">
          <button class="btn-primary" onclick="saveEditMessage()">Save</button>
          <button class="btn-secondary" onclick="closeEditModal()">Cancel</button>
        </div>
      </div>
    </div>

    <form id="form" action="">
      <button type="button" class="emoji-btn" onclick="toggleEmojiPicker()">ğŸ˜Š</button>
      <button type="button" class="alarm-btn" onclick="sendAlarm()" title="Send alarm to all">ğŸ”” ALARM</button>
      <div class="emoji-picker" id="emojiPicker">
        <span onclick="insertEmoji('ğŸ˜€')">ğŸ˜€</span>
        <span onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</span>
        <span onclick="insertEmoji('ğŸ˜')">ğŸ˜</span>
        <span onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</span>
        <span onclick="insertEmoji('ğŸ˜±')">ğŸ˜±</span>
        <span onclick="insertEmoji('ğŸ‰')">ğŸ‰</span>
        <span onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
        <span onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
        <span onclick="insertEmoji('â¤ï¸')">â¤ï¸</span>
        <span onclick="insertEmoji('ğŸ˜˜')">ğŸ˜˜</span>
        <span onclick="insertEmoji('ğŸ™')">ğŸ™</span>
        <span onclick="insertEmoji('ğŸ”¥')">ğŸ”¥</span>
        <span onclick="insertEmoji('ğŸ’¯')">ğŸ’¯</span>
        <span onclick="insertEmoji('ğŸˆ')">ğŸˆ</span>
        <span onclick="insertEmoji('ğŸ•')">ğŸ•</span>
        <span onclick="insertEmoji('âš½')">âš½</span>
        <span onclick="insertEmoji('ğŸ“±')">ğŸ“±</span>
        <span onclick="insertEmoji('âœ¨')">âœ¨</span>
      </div>
      <input id="input" autocomplete="off" placeholder="Write a message..."/>
      <button>Send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Register service worker and check for updates
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            // Check for updates every 30 seconds
            setInterval(() => {
              registration.update().catch(err => console.log('Update check failed:', err));
            }, 30000);

            // Listen for service worker updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Show update prompt
                  if (confirm('ğŸ”„ En ny versjon av appen er tilgjengelig! Vil du oppdatere nÃ¥?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          }).catch(err => console.log('SW registration failed:', err));
        }

        const room = '<%-room%>';
        const userModal = document.getElementById('userModal');
        const passwordModal = document.getElementById('passwordModal');
        const nameInput = document.getElementById('nameInput');
        const colorInput = document.getElementById('colorInput');
        const passwordInput = document.getElementById('passwordInput');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const colorOptions = document.querySelectorAll('.color-option');
        const userList = document.getElementById('userList');
        const userCount = document.getElementById('userCount');
        const editModal = document.getElementById('editModal');
        const editTextarea = document.getElementById('editTextarea');
        
        let currentEditMessageElement = null;
        
        let currentUser = {
          name: localStorage.getItem('chatUserName') || '',
          color: localStorage.getItem('chatUserColor') || '#667eea'
        };

        let onlineUsers = {};

        let socket = io('/admin');
        let form = document.getElementById('form');
        let input = document.getElementById('input');
        let messagesList = document.getElementById('messages');

        // Check for password protection on page load
        async function checkRoomPassword() {
          try {
            const response = await fetch('/verify-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ room: room, password: null })
            });
            const data = await response.json();
            
            // If room requires password, show password modal
            if (data.message === 'Incorrect password' || (data.success === false && data.message !== 'Incorrect password')) {
              passwordModal.classList.add('show');
              passwordInput.focus();
              // Disable form and messages
              form.style.pointerEvents = 'none';
              form.style.opacity = '0.5';
              messagesList.style.pointerEvents = 'none';
              messagesList.style.opacity = '0.5';
            }
          } catch (err) {
            console.log('Password check error:', err);
          }
        }

        // Verify password
        async function verifyPassword() {
          const password = passwordInput.value;
          if (!password) {
            alert('Please enter a password');
            return;
          }

          try {
            const response = await fetch('/verify-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ room: room, password: password })
            });
            const data = await response.json();
            
            if (data.success) {
              passwordModal.classList.remove('show');
              form.style.pointerEvents = 'auto';
              form.style.opacity = '1';
              messagesList.style.pointerEvents = 'auto';
              messagesList.style.opacity = '1';
              passwordInput.value = '';
            } else {
              alert('Incorrect password');
              passwordInput.value = '';
              passwordInput.focus();
            }
          } catch (err) {
            alert('Error verifying password');
            console.log('Verification error:', err);
          }
        }

        // Go back to home
        function goBack() {
          window.location.href = '/';
        }

        // Allow Enter key to submit password
        if (passwordInput) {
          passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              verifyPassword();
            }
          });
        }

        // Toggle user list
        function toggleUserList() {
          userList.classList.toggle('show');
        }

        // Close user list on click outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.online-users') && !e.target.closest('.user-list')) {
            userList.classList.remove('show');
          }
        });

        // Update online user list
        function updateUserList() {
          userList.innerHTML = '';
          let count = 0;
          for (const [socketId, user] of Object.entries(onlineUsers)) {
            count++;
            const item = document.createElement('div');
            item.className = 'user-list-item';
            item.innerHTML = `
              <div class="user-badge" style="background: ${user.color}"></div>
              <span class="user-list-item-name">${user.name}</span>
            `;
            userList.appendChild(item);
          }
          userCount.textContent = count;
        }

        // Apply user info from localStorage
        function initializeUser() {
          if (!currentUser.name) {
            showUserModal();
          } else {
            updateUserDisplay();
          }
        }

        // Show user modal
        function showUserModal() {
          userModal.classList.add('show');
          nameInput.value = currentUser.name;
          colorInput.value = currentUser.color;
          updateColorSelection();
          nameInput.focus();
        }

        // Hide user modal
        function hideUserModal() {
          userModal.classList.remove('show');
        }

        // Save user info
        function saveUserInfo() {
          const name = nameInput.value.trim();
          if (!name) {
            alert('Please enter your name');
            return;
          }
          currentUser.name = name;
          currentUser.color = colorInput.value;
          localStorage.setItem('chatUserName', currentUser.name);
          localStorage.setItem('chatUserColor', currentUser.color);
          hideUserModal();
          updateUserDisplay();
        }

        // Update user display
        function updateUserDisplay() {
          userName.textContent = currentUser.name;
          userInfo.style.setProperty('--user-color', currentUser.color);
          document.documentElement.style.setProperty('--user-color', currentUser.color);
        }

        // Color selection
        function updateColorSelection() {
          colorOptions.forEach(option => {
            if (option.dataset.color === colorInput.value) {
              option.classList.add('selected');
            } else {
              option.classList.remove('selected');
            }
          });
        }

        colorOptions.forEach(option => {
          option.addEventListener('click', () => {
            colorInput.value = option.dataset.color;
            updateColorSelection();
          });
        });

        colorInput.addEventListener('change', updateColorSelection);

        // Load previous messages
        <% if (messages && messages.length > 0) { %>
          <% messages.forEach(function(message) { %>
            const item = document.createElement('li');
            const sender = message.sender || 'User';
            const color = message.color || '#667eea';
            item.innerHTML = `
              <div class="message-sender">
                <span>${sender}</span>
              </div>
              <div class="message-bubble">
                <div><%= message.text %></div>
                <div class="message-time"><%= new Date(message.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) %></div>
              </div>
            `;
            item.style.setProperty('--message-color', color);
            messagesList.appendChild(item);
          <% }); %>
        <% } %>

        // Emoji picker
        function toggleEmojiPicker() {
          const picker = document.getElementById('emojiPicker');
          picker.classList.toggle('show');
        }

        function insertEmoji(emoji) {
          input.value += emoji;
          input.focus();
        }

        // Close emoji picker on click outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.emoji-btn') && !e.target.closest('.emoji-picker')) {
            document.getElementById('emojiPicker').classList.remove('show');
          }
        });

        // Edit message functions
        function editMessage(messageElement) {
          currentEditMessageElement = messageElement;
          const messageText = messageElement.querySelector('.message-bubble > div:first-child').textContent;
          editTextarea.value = messageText;
          editModal.classList.add('show');
          editTextarea.focus();
          editTextarea.select();
        }

        function closeEditModal() {
          editModal.classList.remove('show');
          currentEditMessageElement = null;
          editTextarea.value = '';
        }

        function saveEditMessage() {
          const newText = editTextarea.value.trim();
          if (!newText) {
            alert('Message cannot be empty');
            return;
          }

          // Update the message in UI
          const messageContent = currentEditMessageElement.querySelector('.message-bubble > div:first-child');
          messageContent.textContent = newText;
          
          // Emit update to server
          socket.emit('edit message', {
            room: room,
            sender: currentUser.name,
            newText: newText
          });

          closeEditModal();
        }

        // Close edit modal on click outside
        editModal.addEventListener('click', (e) => {
          if (e.target === editModal) {
            closeEditModal();
          }
        });

        // Allow Ctrl+Enter to save
        editTextarea.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 'Enter') {
            saveEditMessage();
          }
        });

        // Socket events
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          if (input.value) {
            const msg = input.value;
            socket.emit('chat message', { 
              msg, 
              room,
              sender: currentUser.name,
              color: currentUser.color
            });
            input.value = '';
            document.getElementById('emojiPicker').classList.remove('show');
          }
        });

        // Socket events
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          if (input.value) {
            const msg = input.value;
            socket.emit('chat message', { 
              msg, 
              room,
              sender: currentUser.name,
              color: currentUser.color
            });
            input.value = '';
            document.getElementById('emojiPicker').classList.remove('show');
          }
        });

        socket.on('chat message', function(data) {
          const item = document.createElement('li');
          
          // Check if it's a message object or plain text
          if (typeof data === 'object' && data.text) {
            item.innerHTML = `
              <div class="message-sender">
                <span>${data.sender || 'User'}</span>
              </div>
              <div class="message-bubble">
                <div>${data.text}</div>
                <div class="message-time">${new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</div>
              </div>
            `;
            if (data.sender === currentUser.name) {
              item.classList.add('own-message');
              // Add edit actions for own messages
              const actionsDiv = document.createElement('div');
              actionsDiv.className = 'message-actions';
              actionsDiv.innerHTML = `
                <button title="Edit message" onclick="editMessage(this.closest('li'))">
                  <i class="fas fa-edit"></i>
                </button>
              `;
              item.appendChild(actionsDiv);
            }
            if (data.color) {
              item.style.setProperty('--message-color', data.color);
            }
          } else {
            // System message
            item.classList.add('system-message');
            item.textContent = data.toString();
          }
          
          messagesList.appendChild(item);
          
          // Send notification for new message (not for own messages)
          if (typeof data === 'object' && data.text && data.sender !== currentUser.name) {
            sendNotification(data.sender, data.text);
          }
          
          window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('user joined', function(data) {
          onlineUsers[data.socketId] = {
            name: data.name,
            color: data.color
          };
          updateUserList();
        });

        socket.on('user left', function(data) {
          delete onlineUsers[data.socketId];
          updateUserList();
        });

        socket.on('users list', function(data) {
          onlineUsers = data;
          updateUserList();
        });

        socket.on('message edited', function(data) {
          // Find and update the message in the DOM
          const messages = messagesList.querySelectorAll('li');
          messages.forEach(msg => {
            const senderElement = msg.querySelector('.message-sender span');
            if (senderElement && senderElement.textContent === data.sender) {
              const messageContent = msg.querySelector('.message-bubble > div:first-child');
              if (messageContent) {
                messageContent.textContent = data.newText;
              }
            }
          });
        });

        socket.on('connect', () => {
          socket.emit('join', { 
            room: room,
            name: currentUser.name,
            color: currentUser.color
          });
        });

        // Track if page is visible/focused
        let pageVisible = document.visibilityState === 'visible';
        
        // Debounce notifications
        let notificationTimeout = null;
        let pendingNotification = null;
        const NOTIFICATION_DEBOUNCE_MS = 3000; // Batch multiple messages within 3 seconds
        
        // Track page visibility
        document.addEventListener('visibilitychange', () => {
          pageVisible = document.visibilityState === 'visible';
          // Tell service worker about visibility state
          if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
              type: 'PAGE_VISIBILITY',
              visible: pageVisible
            });
          }
        });

        // Request notification permission
        function requestNotificationPermission() {
          if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
          }
        }

        // Send notification for new message
        function sendNotification(sender, message) {
          if ('Notification' in window && Notification.permission === 'granted') {
            // Don't show notification for own messages
            if (sender === currentUser.name) return;
            
            // Don't show notification if page is visible (user can already see it)
            if (pageVisible) return;
            
            // Store the latest notification
            pendingNotification = { sender, message };
            
            // Clear existing debounce timer
            if (notificationTimeout) {
              clearTimeout(notificationTimeout);
            }
            
            // Set new debounce timer - only show notification if no new messages for 3 seconds
            notificationTimeout = setTimeout(() => {
              if (pendingNotification) {
                const { sender: finalSender, message: finalMessage } = pendingNotification;
                showNotificationNow(finalSender, finalMessage);
                pendingNotification = null;
              }
              notificationTimeout = null;
            }, NOTIFICATION_DEBOUNCE_MS);
          }
        }

        // Actually show the notification
        function showNotificationNow(sender, message) {
          // Try to use Service Worker for notifications (better on mobile)
          if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
              type: 'SHOW_NOTIFICATION',
              title: `ğŸ’¬ ${sender}`,
              options: {
                body: message.substring(0, 100),
                icon: '/icons/icon-192.png',
                badge: '/icons/icon-192.png',
                tag: `chat-message-${Date.now()}`,
                requireInteraction: false
              }
            });
          } else {
            // Fallback to regular Notification API
            new Notification(`ğŸ’¬ New message from ${sender}`, {
              body: message.substring(0, 100),
              icon: '/icons/favicon.svg',
              badge: '/icons/favicon.svg',
              tag: `chat-message-${Date.now()}`,
              requireInteraction: false
            });
          }
        }

        // Send alarm to all users
        function sendAlarm() {
          const confirmAlarm = confirm('ğŸš¨ Send ALARM to all users in this room? Everyone will get a high-priority notification!');
          if (confirmAlarm) {
            socket.emit('alarm', {
              room: room,
              sender: currentUser.name,
              timestamp: new Date()
            });
          }
        }

        // Handle incoming alarm
        socket.on('alarm', function(data) {
          // Show alarm notification with high priority
          if ('Notification' in window && Notification.permission === 'granted') {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
              navigator.serviceWorker.controller.postMessage({
                type: 'SHOW_ALARM',
                title: `ğŸš¨ ALARM from ${data.sender}!`,
                options: {
                  body: 'ALARM! Check the chat immediately!',
                  icon: '/icons/icon-192.png',
                  badge: '/icons/icon-192.png',
                  tag: `alarm-${Date.now()}`,
                  requireInteraction: true,
                  silent: false,
                  urgency: 'high'
                }
              });
            } else {
              new Notification(`ğŸš¨ ALARM from ${data.sender}!`, {
                body: 'ALARM! Check the chat immediately!',
                icon: '/icons/favicon.svg',
                badge: '/icons/favicon.svg',
                tag: `alarm-${Date.now()}`,
                requireInteraction: true,
                silent: false
              });
            }
          }
          
          // Add system message to chat
          const item = document.createElement('li');
          item.classList.add('system-message');
          item.style.color = '#ff6b6b';
          item.style.fontWeight = 'bold';
          item.style.fontSize = '1.1rem';
          item.textContent = `ğŸš¨ ${data.sender} sent an ALARM!`;
          messagesList.appendChild(item);
          
          // Flash the screen
          document.body.style.animation = 'none';
          setTimeout(() => {
            document.body.style.animation = 'alarm-flash 0.5s ease-in-out';
          }, 10);
        }

        // Initialize on load
        checkRoomPassword();
        initializeUser();
        updateUserDisplay();
        requestNotificationPermission();
    </script>
  </body>
</html>
